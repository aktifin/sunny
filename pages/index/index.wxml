<!-- 页面内容 -->
<view class="container">
    <!-- 主内容区域 -->
    <view class="flex-grow container mx-auto px-4 py-6">
        
        <!-- 头部区域 -->
        <view class="header-section">
            <image class="mx-auto" src="/apple-touch-icon-120.png" style="width: 80px; height: 80px;"></image>
            <view class="text-3xl font-bold text-orange-600 mb-2">小小英雄成长日历</view>
            <text class="text-stone-500 max-w-xl mx-auto" style="display: block; line-height: 1.6;">
                欢迎来到小英雄的每日挑战！这里记录着你每天的进步。完成9项挑战，每天最高可得 <text class="font-bold text-orange-600">10分</text>。坚持下去，积攒积分换取奖励吧！
            </text>
        </view>

        <!-- 顶部统计行 -->
        <view class="grid grid-cols-3 gap-3 mb-8">
            <!-- 今日得分 -->
            <view class="stat-card bg-white rounded-2xl shadow-lg border border-stone-100 p-5 flex flex-col items-center justify-center text-center relative overflow-hidden">
                <view class="absolute top-0 left-0 w-full h-2 bg-orange-400"></view>
                <text class="text-stone-400 text-xs font-medium uppercase tracking-wider mt-2">今日得分</text>
                <view class="text-3xl font-black text-orange-500 mt-1">{{dailyScore}}</view>
                <text class="text-xs text-orange-300 font-bold mt-0.5">/ 10 分</text>
                <view class="progress-bar" style="margin-top: 0.75rem; width: 100%;">
                    <view class="progress-fill" style="width: {{dailyScore * 10}}%;"></view>
                </view>
            </view>
            
            <!-- 本月得分 -->
            <view class="stat-card bg-white rounded-2xl shadow-lg border border-stone-100 p-5 flex flex-col items-center justify-center text-center relative overflow-hidden">
                <view class="absolute top-0 left-0 w-full h-2 bg-green-400"></view>
                <text class="text-stone-400 text-xs font-medium uppercase tracking-wider mt-2">本月得分</text>
                <view class="text-3xl font-black text-green-500 mt-1">{{monthlyScore}}</view>
                <text class="text-xs text-green-300 font-bold mt-0.5">再接再厉！</text>
            </view>
            
            <!-- 目前总积分 -->
            <view class="stat-card bg-white rounded-2xl shadow-lg border border-stone-100 p-5 flex flex-col items-center justify-center text-center relative overflow-hidden">
                <view class="absolute top-0 left-0 w-full h-2 bg-blue-400"></view>
                <text class="text-stone-400 text-xs font-medium uppercase tracking-wider mt-2">目前总积分</text>
                <view class="text-3xl font-black text-blue-500 mt-1">{{totalScore}}</view>
                <text class="text-xs text-blue-300 font-bold mt-0.5">持续加油！</text>
            </view>
        </view>

        <!-- 主要交互区域 -->
        <view class="grid grid-cols-1 gap-8 mb-8">
            
            <!-- 今日挑战 -->
            <view class="bg-white rounded-2xl shadow-lg border border-stone-100 p-6 relative overflow-hidden">
                <view class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r" style="background: linear-gradient(90deg, #f97316, #fb923c);"></view>
                
                <view class="flex justify-between items-center mb-6">
                    <view class="text-xl font-bold text-stone-700">📝 今日挑战</view>
                    <text id="current-date-display" class="text-sm font-medium text-stone-400 bg-stone-100 px-3 py-1 rounded-full">{{currentDateDisplay}}</text>
                </view>

                <text class="text-sm text-stone-500 mb-4">点击下列项目进行打卡。</text>

                <view class="space-y-3" id="task-list-container">
                    <!-- 任务列表 -->
                    <block wx:for="{{tasksWithStatus}}" wx:key="id">
                        <button 
                            style="width: 100%; margin: 0 auto; margin-bottom: 12px;" 
                            class="task-btn smooth-transition w-full flex items-center justify-between p-3 rounded-xl border-2 text-left group {{item.isCompleted ? 'bg-orange-50 border-orange-500 shadow-md task-completed' : 'bg-white border-stone-100 hover:border-orange-200 hover:bg-stone-50'}} {{isFutureDate ? 'opacity-50 cursor-not-allowed pointer-events-none' : ''}}"
                            bindtap="toggleTask" 
                            data-task-id="{{item.id}}"
                            disabled="{{isFutureDate}}"
                        >
                            <view class="flex items-center gap-3 flex-grow">
                                <view class="w-10 h-10 rounded-full flex items-center justify-center text-xl smooth-transition {{item.isCompleted ? 'bg-orange-100 scale-110' : 'bg-stone-100 text-stone-300'}}">
                                    {{item.icon}}
                                </view>
                                <view class="flex-grow">
                                    <view class="font-bold {{item.isCompleted ? 'text-orange-700' : 'text-stone-700'}}">{{item.text}}</view>
                                    <view class="text-xs text-stone-400">{{item.desc}}</view>
                                </view>
                            </view>
                            <view class="flex items-center gap-2">
                                <text class="text-xs font-bold text-orange-400 bg-orange-50 px-2 py-1 rounded">+{{item.points}}分</text>
                                <view class="w-6 h-6 rounded-full border-2 flex items-center justify-center smooth-transition {{item.isCompleted ? 'bg-orange-500 border-orange-500 scale-125' : 'border-stone-200'}}">
                                    <text wx:if="{{item.isCompleted}}" class="text-white text-xs">✓</text>
                                </view>
                            </view>
                        </button>
                    </block>
                </view>
            </view>

            <!-- 积分成长曲线 -->
            <view class="bg-white rounded-2xl shadow-lg border border-stone-100 p-6 relative">
                <view class="absolute top-0 left-0 w-full h-2" style="background: linear-gradient(90deg, #60a5fa, #3b82f6);"></view>
                <view class="mb-4">
                    <view class="text-xl font-bold text-stone-700">📈 积分成长曲线</view>
                    <text class="text-sm text-stone-500">观察你最近的努力成果，保持上升趋势！</text>
                </view>
                
                <view class="chart-container">
                    <canvas type="2d" id="growthChart" style="width: 100%; height: 300px; box-sizing: border-box;"></canvas>
                </view>
            </view>
        </view>

        <!-- 底部区域：日历视图 -->
        <view class="bg-white rounded-2xl shadow-lg border border-stone-100 p-6 mb-8 relative">
            <view class="absolute top-0 left-0 w-full h-2" style="background: linear-gradient(90deg, #22c55e, #34d399);"></view>
            
            <view class="flex flex-col justify-between items-center mb-6">
                <view>
                    <view class="text-xl font-bold text-stone-700">📅 积分月历</view>
                    <text class="text-sm text-stone-500">点击日历上的日期可以补录或查看当天的记录。</text>
                </view>
                <view class="flex items-center gap-2 mt-4">
                    <button id="prev-month" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; padding: 0;" class="smooth-transition hover:bg-orange-100 rounded-full text-stone-400 hover:text-orange-500 transition" bindtap="changeMonth" data-offset="-1">◀</button>
                    <text id="calendar-month-year" class="font-bold text-lg text-stone-700 w-64 text-center">{{calendarMonthYear}}</text>
                    <button id="next-month" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; padding: 0;" class="smooth-transition hover:bg-orange-100 rounded-full text-stone-400 hover:text-orange-500 transition" bindtap="changeMonth" data-offset="1">▶</button>
                </view>
            </view>

            <!-- 日历网格头部 -->
            <view class="grid grid-cols-7 mb-4">
                <view class="text-center text-xs font-bold text-stone-400 py-3" style="background: linear-gradient(135deg, rgba(249,115,22,0.05) 0%, rgba(249,115,22,0.02) 100%); border-radius: 0.5rem;">日</view>
                <view class="text-center text-xs font-bold text-stone-400 py-3">一</view>
                <view class="text-center text-xs font-bold text-stone-400 py-3">二</view>
                <view class="text-center text-xs font-bold text-stone-400 py-3">三</view>
                <view class="text-center text-xs font-bold text-stone-400 py-3">四</view>
                <view class="text-center text-xs font-bold text-stone-400 py-3">五</view>
                <view class="text-center text-xs font-bold text-stone-400 py-3" style="background: linear-gradient(135deg, rgba(249,115,22,0.05) 0%, rgba(249,115,22,0.02) 100%); border-radius: 0.5rem;">六</view>
            </view>

            <!-- 日历天数 -->
            <view id="calendar-grid" class="grid grid-cols-7 mb-6" style="gap: 0.25rem; width: 100%;">
                <!-- 日历天数 -->
                <block wx:for="{{calendarDays}}" wx:key="dateKey">
                    <!-- 空白单元格（上月/下月） -->
                    <view wx:if="{{item.isEmpty}}" 
                        class="rounded-lg relative"
                        style="flex: 1 1 auto; height: 44px; background: transparent;"
                    >
                    </view>
                    
                    <!-- 当月日期单元格 -->
                    <view wx:else
                        class="calendar-cell rounded-lg relative smooth-transition {{item.classes}}"
                        bindtap="setViewDate"
                        data-date="{{item.dateKey}}"
                        style="{{item.isFutureDate ? 'pointer-events: none; opacity: 0.5;' : ''}}"
                    >
                        <view class="flex flex-col items-center justify-center w-full h-full">
                            <text class="text-base font-bold">{{item.day}}</text>
                            <text wx:if="{{item.score !== null && item.score > 0}}" class="text-10px font-bold rounded-sm" style="margin-top: 1px; padding: 1px 3px; background: rgba(249,115,22,0.8); color: white; line-height: 1;">{{item.score}}</text>
                            <view wx:if="{{item.isToday && item.score === null}}" class="w-1 h-1 bg-orange-500 rounded-full absolute bottom-1 animate-pulse"></view>
                        </view>
                    </view>
                </block>
            </view>

            <!-- 图例 - 改进样式 -->
            <view class="flex flex-wrap justify-center gap-4 mt-6 mb-6 p-4 bg-stone-50 rounded-lg">
                <view class="flex items-center gap-2">
                    <view class="w-3 h-3 rounded-full bg-green-500 shadow-sm"></view>
                    <text class="text-xs text-stone-600 font-medium">满分(10)</text>
                </view>
                <view class="flex items-center gap-2">
                    <view class="w-3 h-3 rounded-full bg-blue-400 shadow-sm"></view>
                    <text class="text-xs text-stone-600 font-medium">优秀(6-9)</text>
                </view>
                <view class="flex items-center gap-2">
                    <view class="w-3 h-3 rounded-full bg-orange-300 shadow-sm"></view>
                    <text class="text-xs text-stone-600 font-medium">加油(1-5)</text>
                </view>
            </view>
            
            <!-- 本月统计标题 -->
            <view class="mb-4">
                <view class="text-xl font-bold text-stone-700">📊 本月积分统计</view>
                <text class="text-sm text-stone-500">查看当前显示月份的详细积分情况。</text>
            </view>
            
            <!-- 统计卡片 -->
            <view id="monthly-stats" class="grid grid-cols-3 gap-3">
                <view class="stat-card bg-white rounded-2xl shadow-lg border border-stone-100 p-4 flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <view class="absolute top-0 left-0 w-full h-2" style="background: linear-gradient(90deg, #3b82f6, #60a5fa);"></view>
                    <text class="text-stone-400 text-xs font-medium uppercase tracking-wider mt-2">总积分</text>
                    <view class="text-2xl font-black text-blue-500 mt-1">{{displayedMonthTotal}}</view>
                    <view class="text-xs text-stone-500 mt-0.5">当前月份</view>
                </view>
                
                <view class="stat-card bg-white rounded-2xl shadow-lg border border-stone-100 p-4 flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <view class="absolute top-0 left-0 w-full h-2" style="background: linear-gradient(90deg, #f97316, #fb923c);"></view>
                    <text class="text-stone-400 text-xs font-medium uppercase tracking-wider mt-2">平均得分</text>
                    <view class="text-2xl font-black text-orange-500 mt-1">{{averageScore}}</view>
                    <view class="text-xs text-stone-500 mt-0.5">/ 10 分</view>
                </view>
                
                <view class="stat-card bg-white rounded-2xl shadow-lg border border-stone-100 p-4 flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <view class="absolute top-0 left-0 w-full h-2" style="background: linear-gradient(90deg, #22c55e, #34d399);"></view>
                    <text class="text-stone-400 text-xs font-medium uppercase tracking-wider mt-2">满分天数</text>
                    <view class="text-2xl font-black text-green-500 mt-1">{{perfectDays}}</view>
                    <view class="text-xs text-stone-500 mt-0.5">10分天数</view>
                </view>
            </view>
        </view>
    </view>

    <view class="bg-white border-t border-stone-100 py-6 text-center">
        <text class="text-stone-400 text-sm">坚持就是胜利！每天一点点，进步看得见。</text>
    </view>
</view>